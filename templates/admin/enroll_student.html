{% extends "base.html" %}

{% block title %}Enroll Students{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">
        <i class="bi bi-person-plus"></i> Enroll Students in Subjects
    </h2>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {% if category == 'success' %}<i class="bi bi-check-circle me-2"></i>{% endif %}
                    {% if category == 'danger' %}<i class="bi bi-exclamation-triangle me-2"></i>{% endif %}
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    <!-- Enrollment Form -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-pencil-square me-2"></i>New Enrollment</h5>
        </div>
        <div class="card-body">
            <form id="enrollmentForm" method="POST" action="{{ url_for('admin_enroll_student') }}">
                <div class="row g-3">
                    <!-- Department -->
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="department" class="form-label">Department</label>
                            <select class="form-select" id="department" required>
                                <option value="">-- Select Department --</option>
                                {% for department in departments %}
                                <option value="{{ department.dept_id }}">{{ department.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <!-- Semester -->
                    <div class="col-md-2">
                        <div class="form-group">
                            <label for="semester" class="form-label">Semester</label>
                            <select class="form-select" id="semester" required disabled>
                                <option value="">-- Select Semester --</option>
                                {% for i in range(1,9) %}
                                <option value="{{ i }}">Semester {{ i }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <!-- Subject -->
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="subject" class="form-label">Subject</label>
                            <select class="form-select" id="subject" name="subject_id" required disabled>
                                <option value="">-- Select Subject --</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Student -->
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="student" class="form-label">Student</label>
                            <select class="form-select" id="student" name="student_id" required>
                                <option value="">-- Select Student --</option>
                                {% for student in students %}
                                <option value="{{ student.student_id }}">{{ student.name }} ({{ student.student_id }})</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary mt-3">
                    <i class="bi bi-plus-circle me-2"></i>Enroll Student
                </button>
            </form>
        </div>
    </div>

    <!-- Current Enrollments -->
    <div class="card shadow-sm">
        <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>Current Enrollments</h5>
            <div class="input-group" style="width: 300px;">
                <input type="text" id="enrollmentSearch" class="form-control" placeholder="Search enrollments...">
                <button class="btn btn-outline-light" type="button">
                    <i class="bi bi-search"></i>
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="enrollmentsTable">
                    <thead class="table-light">
                        <tr>
                            <th><i class="bi bi-book me-1"></i> Subject</th>
                            <th><i class="bi bi-building me-1"></i> Department</th>
                            <th><i class="bi bi-calendar3 me-1"></i> Semester</th>
                            <th><i class="bi bi-people me-1"></i> Enrolled Students</th>
                            <th><i class="bi bi-gear me-1"></i> Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if enrollments %}
                            {% for item in enrollments %}
                            <tr>
                                <td>{{ item.subject.name }}</td>
                                <td>{{ item.subject.department_name }}</td>
                                <td>Semester {{ item.subject.semester }}</td>
                                <td>
                                    {% if item.enrolled_students %}
                                        <button class="btn btn-sm btn-outline-info" type="button" data-bs-toggle="collapse" 
                                                data-bs-target="#students{{ loop.index }}">
                                            <i class="bi bi-people me-1"></i>{{ item.enrolled_students|length }} students <i class="bi bi-chevron-down ms-1"></i>
                                        </button>
                                        <div class="collapse mt-2" id="students{{ loop.index }}">
                                            <ul class="list-group list-group-flush">
                                                {% for student_name in item.enrolled_students %}
                                                <li class="list-group-item"><i class="bi bi-person me-2"></i>{{ student_name }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    {% else %}
                                        <span class="badge bg-secondary">No students enrolled</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="5" class="text-center py-4">
                                    <div class="alert alert-info mb-0">
                                        <i class="bi bi-info-circle me-2"></i>No enrollments found. Use the form above to enroll students.
                                    </div>
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const departmentSelect = document.getElementById('department');
    const semesterSelect = document.getElementById('semester');
    const subjectSelect = document.getElementById('subject');
    const studentSelect = document.getElementById('student');
    const searchInput = document.getElementById('enrollmentSearch');
    const enrollmentForm = document.getElementById('enrollmentForm');
    
    // Initial setup for select elements with nice UI feedback
    function setupFormElements() {
        // Add Bootstrap validation classes
        enrollmentForm.classList.add('was-validated');
        
        // Add loading spinners to button when form is submitted
        enrollmentForm.addEventListener('submit', function(event) {
            if (!this.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
                return;
            }
            
            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Enrolling...';
            submitBtn.disabled = true;
        });
    }
    
    // Enable semester select when department is chosen
    departmentSelect.addEventListener('change', function() {
        semesterSelect.disabled = !this.value;
        semesterSelect.value = '';
        subjectSelect.innerHTML = '<option value="">-- Select Subject --</option>';
        subjectSelect.disabled = true;
        
        // Visual feedback
        if (this.value) {
            semesterSelect.parentElement.classList.add('border-start', 'border-3', 'border-success', 'ps-2');
            setTimeout(() => {
                semesterSelect.parentElement.classList.remove('border-start', 'border-3', 'border-success', 'ps-2');
            }, 1000);
        }
    });
    
    // Load subjects when semester is chosen
    semesterSelect.addEventListener('change', function() {
        const departmentId = departmentSelect.value;
        const semester = this.value;
        
        if (!departmentId || !semester) {
            subjectSelect.innerHTML = '<option value="">-- Select Subject --</option>';
            subjectSelect.disabled = true;
            return;
        }
        
        // Show loading indicator
        subjectSelect.innerHTML = '<option value="">Loading subjects...</option>';
        subjectSelect.disabled = true;
        
        // Visual feedback
        subjectSelect.parentElement.classList.add('position-relative');
        const loadingSpinner = document.createElement('div');
        loadingSpinner.className = 'position-absolute top-0 end-0 mt-2 me-2';
        loadingSpinner.innerHTML = '<div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';
        subjectSelect.parentElement.appendChild(loadingSpinner);
        
        // Fetch subjects for the selected department and semester
        fetch(`/api/subjects?department_id=${departmentId}&semester=${semester}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                subjectSelect.innerHTML = '<option value="">-- Select Subject --</option>';
                
                if (data.subjects && data.subjects.length) {
                    data.subjects.forEach(subject => {
                        const option = document.createElement('option');
                        option.value = subject.subject_id;
                        option.textContent = subject.name;
                        subjectSelect.appendChild(option);
                    });
                    subjectSelect.disabled = false;
                    
                    // Show success message
                    const successAlert = document.createElement('div');
                    successAlert.className = 'alert alert-success alert-dismissible fade show mt-2';
                    successAlert.innerHTML = `
                        <i class="bi bi-check-circle me-2"></i>
                        Found ${data.subjects.length} subjects for Semester ${semester}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    subjectSelect.parentElement.appendChild(successAlert);
                    
                    // Auto-remove the alert after 3 seconds
                    setTimeout(() => {
                        successAlert.remove();
                    }, 3000);
                } else {
                    subjectSelect.innerHTML = '<option value="">No subjects available</option>';
                    
                    // Show info message
                    const infoAlert = document.createElement('div');
                    infoAlert.className = 'alert alert-info alert-dismissible fade show mt-2';
                    infoAlert.innerHTML = `
                        <i class="bi bi-info-circle me-2"></i>
                        No subjects found for this department and semester
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    subjectSelect.parentElement.appendChild(infoAlert);
                    
                    // Auto-remove the alert after 3 seconds
                    setTimeout(() => {
                        infoAlert.remove();
                    }, 3000);
                }
            })
            .catch(error => {
                console.error('Error fetching subjects:', error);
                subjectSelect.innerHTML = '<option value="">Error loading subjects</option>';
                
                // Show error message
                const errorAlert = document.createElement('div');
                errorAlert.className = 'alert alert-danger alert-dismissible fade show mt-2';
                errorAlert.innerHTML = `
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Error loading subjects. Please try again.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                subjectSelect.parentElement.appendChild(errorAlert);
            })
            .finally(() => {
                // Remove the loading spinner
                subjectSelect.parentElement.removeChild(loadingSpinner);
            });
    });
    
    // Search functionality for enrollments table with highlighting
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const rows = document.querySelectorAll('#enrollmentsTable tbody tr');
        
        if (searchTerm.length > 0) {
            // Add search indicator
            this.classList.add('border-primary');
            
            // Count visible rows for feedback
            let visibleRows = 0;
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const isMatch = text.includes(searchTerm);
                row.style.display = isMatch ? '' : 'none';
                
                if (isMatch) {
                    visibleRows++;
                    
                    // Highlight matching content
                    const cells = row.querySelectorAll('td');
                    cells.forEach(cell => {
                        const originalText = cell.innerText;
                        if (originalText.toLowerCase().includes(searchTerm)) {
                            const regex = new RegExp(`(${searchTerm})`, 'gi');
                            cell.innerHTML = originalText.replace(
                                regex, 
                                '<span class="bg-warning">$1</span>'
                            );
                        }
                    });
                }
            });
            
            // Show search results count
            const feedbackElement = document.getElementById('searchFeedback') || document.createElement('div');
            feedbackElement.id = 'searchFeedback';
            feedbackElement.className = 'mt-2 small text-muted';
            feedbackElement.innerHTML = `Found ${visibleRows} matching results`;
            
            if (!document.getElementById('searchFeedback')) {
                searchInput.parentElement.after(feedbackElement);
            }
        } else {
            // Remove search styling when search is cleared
            this.classList.remove('border-primary');
            
            // Show all rows and remove highlighting
            rows.forEach(row => {
                row.style.display = '';
                
                // Reset cell content to remove highlights
                const cells = row.querySelectorAll('td');
                cells.forEach(cell => {
                    cell.innerHTML = cell.innerText;
                });
            });
            
            // Remove the feedback
            const feedbackElement = document.getElementById('searchFeedback');
            if (feedbackElement) {
                feedbackElement.remove();
            }
        }
    });
    
    // Initialize form setup
    setupFormElements();
    
    // Enable tooltips if Bootstrap is available
    if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }
});
</script>
{% endblock %}